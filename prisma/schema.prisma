generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Agency {
  id           String   @id @default(cuid())
  name         String
  branchName   String?
  
  // Ubicaci칩n predeterminada de la inmobiliaria
  province     String?
  city         String?
  neighborhood String?
  
  website      String?
  googlePlaceId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reviews      ReviewProjection[]
  events       ReviewEvent[]

  @@index([name])
}

model ReviewEvent {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())

  // event identity
  eventType     String
  reviewId      String
  agencyId      String

  // canonical payload (store string to preserve canonicalization)
  payloadJson   String

  // hash chain
  prevHash      String?
  eventHash     String   @unique
  signature     String?  // optional (KMS later)

  // anchoring
  anchorDate    DateTime?

  agency        Agency   @relation(fields: [agencyId], references: [id])

  @@index([agencyId, createdAt])
  @@index([reviewId, createdAt])
}

model ReviewProjection {
  reviewId            String  @id
  agencyId            String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // main fields
  overallRating       Int      // 1..5
  comment             String
  province            String
  city                String
  neighborhood        String?
  operationType       String   // BUY/SELL/RENT

  // service experience scores (1-5)
  accompanimentScore      Int?     // Acompa침amiento y confianza
  responseTimeScore       Int?     // Tiempo de respuesta
  problemResolutionScore  Int?     // Gesti칩n y resoluci칩n de situaciones

  // NPS (1-10)
  npsScore            Int?     // Net Promoter Score

  // derived
  positivesOverall    Float?
  compositeRating     Float?   // Rating compuesto ponderado
  severityPoints      Int      @default(0)
  isVerifiedOperation Boolean  @default(false)

  // moderation
  status              String   @default("VISIBLE") // VISIBLE/HIDDEN

  agency              Agency   @relation(fields: [agencyId], references: [id])

  @@index([agencyId, createdAt])
  @@index([province, city, neighborhood])
}